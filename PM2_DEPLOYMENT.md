# PM2 Деплой и Автоматическое Обновление

Этот проект настроен для работы с PM2 для управления фронтендом и бэкендом, а также автоматического обновления с Git.

## Структура

- `ecosystem.config.js` - конфигурация PM2
- `deploy.sh` - полный деплой с пересборкой
- `update.sh` - быстрое обновление с Git

## Первоначальная настройка

### 1. Установка зависимостей

```bash
# В корне проекта
cd orgchart
npm install

# В бэкенде
cd backend
npm install

# Во фронтенде
cd ../frontend
npm install
npm run build
```

### 2. Создание директорий для логов

```bash
mkdir -p orgchart/backend/logs orgchart/frontend/logs
```

### 3. Первый запуск

```bash
# Запуск всех приложений
pm2 start ecosystem.config.js --env production

# Сохранение конфигурации
pm2 save

# Настройка автозапуска
pm2 startup
```

## Использование

### Полный деплой (рекомендуется для первого запуска)

```bash
./deploy.sh
```

Этот скрипт:
- Переключается на master ветку
- Получает последние изменения с Git
- Устанавливает все зависимости
- Собирает фронтенд
- Перезапускает все приложения через PM2

### Быстрое обновление

```bash
./update.sh
```

Этот скрипт:
- Получает последние изменения с Git
- Обновляет зависимости только при необходимости
- Пересобирает фронтенд только при изменении кода
- Перезапускает приложения

### Ручное управление PM2

```bash
# Просмотр статуса
pm2 status

# Просмотр логов
pm2 logs

# Логи конкретного приложения
pm2 logs orgchart-backend
pm2 logs orgchart-frontend

# Перезапуск приложений
pm2 reload all
pm2 reload orgchart-backend
pm2 reload orgchart-frontend

# Остановка приложений
pm2 stop all

# Удаление приложений
pm2 delete all
```

## Конфигурация

### Порты

- **Фронтенд**: http://localhost:3000
- **Бэкенд**: http://localhost:3001

### Переменные окружения

Приложения используют переменные из файлов `.env` и `.env.production`.

### Логи

Логи сохраняются в:
- `orgchart/backend/logs/` - логи бэкенда
- `orgchart/frontend/logs/` - логи фронтенда

## Автоматическое обновление

Для настройки автоматического обновления можно использовать cron:

```bash
# Добавить в crontab (обновление каждый час)
0 * * * * cd /root/orgportal/orgportal && ./update.sh >> /var/log/orgportal-update.log 2>&1
```

## Мониторинг

```bash
# Мониторинг в реальном времени
pm2 monit

# Информация о процессах
pm2 show orgchart-backend
pm2 show orgchart-frontend
```

## Устранение неполадок

### Если приложения не запускаются

1. Проверьте логи:
```bash
pm2 logs
```

2. Проверьте статус:
```bash
pm2 status
```

3. Перезапустите:
```bash
pm2 restart all
```

### Если обновление не работает

1. Проверьте права доступа к Git репозиторию
2. Убедитесь, что ветка master существует
3. Проверьте подключение к интернету

### Очистка

```bash
# Остановить и удалить все процессы
pm2 stop all
pm2 delete all

# Очистить сохраненную конфигурацию
pm2 cleardump
``` 